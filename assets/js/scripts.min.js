function mtpt_init_editor(a){if(jQuery("#"+a).length){var b=function(a){var c;if(a.match("{{")){for(;null!=(c=a.next())&&("}"!=c||"}"!=a.next()););return a.eat("}"),"mustache"}if(a.match("%")){for(;null!=(c=a.next())&&"%"!=c;);return a.eat("%"),"command"}for(;null!=a.next()&&!a.match("{{",!1)&&!a.match("%",!1););return null},c={lineNumbers:!0,matchBrackets:!0,tabSize:2,indentUnit:2,indentWithTabs:!0,enterMode:"keep",tabMode:"shift",lineWrapping:!0,extraKeys:{"Ctrl-Space":"autocomplete"}};return CodeMirror.defineMode("mustache",function(c,d){var e={token:b};return CodeMirror.overlayMode(CodeMirror.getMode(c,d.backdrop||jQuery("#"+a).data("mode")),e)}),c.mode="mustache",mtpt_code_editor=CodeMirror.fromTextArea(document.getElementById(a),c),mtpt_code_editor.on("blur",function(a){a.save(),jQuery(a.getInputField()).trigger("change")}),mtpt_code_editor}}function find_if_in_wrapper(a,b,c){if(in_entry=!1,a.findPrevious()){console.log(a);var d=a.from();if(b.findPrevious()){var e=b.from();if(d.line>e.line)in_entry=d;else{if(d.line!==e.line)return console.log(d),a=c.getSearchCursor("{{#each ",d),find_if_in_wrapper(a,b,c);d.ch>e.ch&&(in_entry=d)}}else console.log(d),in_entry=d}if(in_entry){var f=c.getSearchCursor("}}",in_entry);if(f.findNext()){var e=f.from();start_tag=a.to(),in_entry=c.getRange(start_tag,e)}}return in_entry}function tagFields(a,b){if(8!==b.keyCode){var c=a.getCursor(),d=a.getSearchCursor("{{#each ",c),e=a.getSearchCursor("{{/each}}",c),f=a.getSearchCursor("{{#if ",c),g=a.getSearchCursor("{{/if",c),h=find_if_in_wrapper(d,e,a),i=!1;if(f.findPrevious()){var j=f.from();if(g.findPrevious()){var k=g.from();j.line>k.line?i=!0:j.line===k.line&&j.ch>k.ch&&(i=!0)}else i=!0}if(i){var l=a.getSearchCursor("}}",j);if(l.findNext()){var k=l.from();start_tag=d.to(),i=a.getRange(start_tag,k)}}if(!a.state.completionActive||18===b.keyCode){var n,m=a.getTokenAt(c),n=m.string.slice(0);if(n&&m.type){var o={};m.type&&(h?(i||(o={"/each":"/each"}),o["@key"]="@key",jQuery(".metaplate-autocomplete-in-entry-"+m.type).each(function(){var a=jQuery(this);(a.hasClass("parent-"+h)||a.hasClass("parant-all"))&&(o[a.data("slug")]=a.data("label"),a.data("label").indexOf("#")<0&&(o["#if "+a.data("slug")]="#if "+a.data("label")))})):jQuery(".metaplate-autocomplete-out-entry-"+m.type).each(function(){var a=jQuery(this);o[a.data("slug")]=a.data("label"),a.data("label").indexOf("#")<0&&(o["#if "+a.data("slug")]="#if "+a.data("label"))}),i&&(o["else"]="else",o["/if"]="/if"));var p=[],q=[],r={};for(var s in o)o.hasOwnProperty(s)&&(s.indexOf("#")<0&&s.indexOf("/")<0?p.push(s):q.push(s));p.sort(),q.sort(),p=p.concat(q),jQuery.each(p,function(a,b){r[b]=o[b]}),CodeMirror.showHint(a,CodeMirror.hint.elementfield,{fields:r,mode:m.type})}}}}var metaplate_canvas=!1,mtpt_get_config_object,mtpt_record_change,mtpt_canvas_init,mtpt_get_default_setting,mtpt_code_editor,init_magic_tags,mtpt_rebuild_magics,config_object={},magic_tags=[];jQuery(function(a){init_magic_tags=function(){var a=jQuery(".magic-tag-enabled");a.each(function(a,b){var c=jQuery(b);if(c.hasClass("magic-tag-init-bound")){var d=c.parent().find(".magic-tag-init");return c.is(":visible")?d.show():d.hide(),void 0}var e=jQuery('<span class="dashicons dashicons-editor-code magic-tag-init"></span>'),f=jQuery('<span style="position:relative;display:inline-block; width:100%;"></span>');c.is("input")&&e.css("borderBottom","none"),c.hasClass("metaplate-conditional-value-field")&&f.width("auto"),e.insertAfter(c),c.addClass("magic-tag-init-bound"),c.is(":visible")?e.show():e.hide()})},mtpt_get_config_object=function(b){a("#metaplate-id").trigger("change");for(var c=a(b),d=a("#metaplate-live-config").val(),e=a("[required]"),f=!0,g=0;g<e.length;g++)e[g].value.length<=0&&a(e[g]).is(":visible")?(a(e[g]).addClass("metaplate-input-error"),f=!1):a(e[g]).removeClass("metaplate-input-error");return f&&(metaplate_canvas=d),c.data("config",d),f},mtpt_record_change=function(){jQuery("#metaplate-id").trigger("change"),jQuery("#metaplate-field-sync").trigger("refresh")},mtpt_canvas_init=function(){metaplate_canvas||(jQuery("#metaplate-main-canvas").on("keydown keyup change","input, select, textarea",function(){config_object=jQuery("#metaplate-main-form").formJSON(),jQuery("#metaplate-live-config").val(JSON.stringify(config_object)).trigger("change")}),mtpt_init_editor(),metaplate_canvas=jQuery("#metaplate-live-config").val(),config_object=JSON.parse(metaplate_canvas)),a(".color-field").wpColorPicker({change:function(){a("#metaplate-id").trigger("change")}}),mtpt_rebuild_magics()},mtpt_get_default_setting=function(a){var b="node_"+Math.round(99887766*Math.random())+"_"+Math.round(99887766*Math.random()),d=a.trigger?a.trigger:a.params.trigger;switch(d.data("group")?d.data("group"):"node_"+Math.round(99887766*Math.random())+"_"+Math.round(99887766*Math.random()),d.data("addNode")&&(config_object[d.data("addNode")]||(config_object[d.data("addNode")]={}),config_object[d.data("addNode")][b]={_id:b}),d.data("removeNode")&&config_object[d.data("removeNode")]&&delete config_object[d.data("removeNode")],d.data("script")){case"add-to-object":}jQuery("#metaplate-live-config").val(JSON.stringify(config_object)),jQuery("#metaplate-field-sync").trigger("refresh")},a.widget("custom.catcomplete",a.ui.autocomplete,{_create:function(){this._super(),this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(b,c){var d=this,e="";a.each(c,function(a,c){var f;c.category!=e&&(b.append("<li class='ui-autocomplete-category'>"+c.category+"</li>"),e=c.category),f=d._renderItemData(b,c),c.category&&f.attr("aria-label",c.category+" : "+c.label)})}}),mtpt_rebuild_magics=function(){function b(a){return a.split(/ \s*/)}function c(a){return b(a).pop()}a(".magic-tag-enabled").bind("keydown",function(b){b.keyCode===a.ui.keyCode.TAB&&a(this).catcomplete("instance").menu.active&&b.preventDefault()}).catcomplete({minLength:0,source:function(b,d){magic_tags=[];var e="";if(config_object.search_form&&config_object.form_fields){var g=["autocomplete_item"];for(e=a("#metaplate-label-tags").text(),f=0;f<g.length;f++)magic_tags.push({label:"{"+g[f]+"}",category:e})}d(a.ui.autocomplete.filter(magic_tags,c(b.term)))},focus:function(){return!1},select:function(a,c){var d=b(this.value);return d.pop(),d.push(c.item.value),this.value=d.join(" "),!1}})},a(document).on("click",".metaplate-card-actions .confirm a",function(b){b.preventDefault();var c=a(this).closest(".metaplate-card-content");actions=c.find(".row-actions"),actions.slideToggle(300)}),a(document).on("keyup change",'[data-format="slug"]',function(b){var c=a(this);return c.data("master")&&c.prop("required")&&this.value.length<=0&&"change"===b.type?(this.value=a(c.data("master")).val().replace(/[^a-z0-9]/gi,"_").toLowerCase(),this.value.length&&c.trigger("change"),void 0):(this.value=this.value.replace(/[^a-z0-9]/gi,"_").toLowerCase(),void 0)}),a(document).on("keyup change","[data-sync]",function(){var b=a(this),c=a(b.data("sync"));c.is("input")?c.val(b.val()).trigger("change"):c.text(b.val())}),a(document).on("click",".metaplate-nav-tabs > li > a",function(b){b.preventDefault();for(var c=a(this),d=c.attr("href"),e=a("[required]"),f=!0,g=0;g<e.length;g++)e[g].value.length<=0&&a(e[g]).is(":visible")?(a(e[g]).addClass("metaplate-input-error"),f=!1):a(e[g]).removeClass("metaplate-input-error");f&&(a(".metaplate-nav-tab.active").removeClass("active"),c.parent().addClass("active"),a(".metaplate-editor-panel").hide(),a(d).show(),mtpt_code_editor&&(mtpt_code_editor.toTextArea(),mtpt_code_editor=!1),a(d).find(".metaplate-code-editor").length&&(mtpt_init_editor(a(d).find(".metaplate-code-editor").prop("id")),mtpt_code_editor.refresh(),mtpt_code_editor.focus()),jQuery("#metaplate-active-tab").val(d).trigger("change"))}),a(document).on("click","[data-remove-parent]",function(){var c=a(this);c.closest(c.data("removeParent")).remove(),mtpt_record_change()}),a("body").on("click",".magic-tag-init",function(){var c=a(this),d=c.prev();d.focus().trigger("init.magic")}),a(document).on("change","[data-live-sync]",function(){mtpt_record_change()}),a(".wp-baldrick").baldrick({request:ajaxurl,method:"POST"}),window.onbeforeunload=function(){return metaplate_canvas&&metaplate_canvas!==jQuery("#metaplate-live-config").val()?!0:void 0}}),function(){"use strict";function b(b,c){var d=b.getCursor(),e=b.getTokenAt(d),f=[],g=c.fields;switch("sqlmustache"===b.getMode().name&&(c.mode="sqlmustache"),c.mode){case"mustache":var h={start:"{{",end:"}}"},i=e.string.slice(2);break;case"command":var h={start:"%",end:"%"},i=e.string.slice(1);break;default:var h={start:"",end:"}}"},i=e.string}for(var j in g)(0==j.indexOf(i)||"{"===i||0==g[j].indexOf(i))&&("{"===i&&(h.start="{"),f.push({text:h.start+j+h.end,displayText:g[j]}));return{list:f,from:a(d.line,e.start),to:a(d.line,e.end)}}if("undefined"!=typeof CodeMirror&&metaplate_canvas!==!1){var a=CodeMirror.Pos;CodeMirror.registerHelper("hint","elementfield",b)}}();